# 图片处理功能说明

## 功能概述

在办小助手现已支持图片处理功能！用户可以向公众号发送图片，系统会自动下载并使用 Gemini AI 进行分析理解。

## 功能特点

### 1. 智能图片接收
- 用户发送图片后，系统立即下载到服务器
- 图片按接收时间自动重命名（格式：`用户ID_时间戳.扩展名`）
- 支持多种图片格式：JPG、PNG、GIF、WEBP

### 2. 图片会话管理
- 支持用户连续发送多张图片
- 每次收到图片后，系统会提示："已接收到图片（共X张），是否继续发送图片还是根据图片提问？"
- 图片会话有效期：10分钟（可在代码中配置）

### 3. AI图片理解
- 使用 Google Gemini AI 进行图片分析
- 支持图片说明、内容识别、视觉问答等多种场景
- 可同时处理多张图片

### 4. 会话隔离
- 每次处理完成后，图片会话自动清空
- 下次发送图片时，不会携带之前的图片
- 确保不同对话之间互不干扰

## 使用流程

```
用户操作                    系统响应
───────────────────────────────────────────────
发送图片1                   → "已接收到图片（共1张），是否继续发送图片还是根据图片提问？"
发送图片2                   → "已接收到图片（共2张），是否继续发送图片还是根据图片提问？"
发送文本提问："这是什么？"   → AI分析所有图片，返回详细回答
                           （此时图片会话自动清空）
发送新的图片                → "已接收到图片（共1张），..."（新的会话开始）
```

## 示例场景

### 场景1：识别物品
```
用户: [发送一张桌子的图片]
系统: 已接收到图片（共1张），是否继续发送图片还是根据图片提问？
用户: 这是什么家具？
系统: 这是一张木质餐桌，看起来是现代简约风格...
```

### 场景2：对比分析
```
用户: [发送图片A]
系统: 已接收到图片（共1张），是否继续发送图片还是根据图片提问？
用户: [发送图片B]
系统: 已接收到图片（共2张），是否继续发送图片还是根据图片提问？
用户: 这两张图片有什么区别？
系统: 第一张图片显示..., 第二张图片显示..., 主要区别在于...
```

### 场景3：文字识别
```
用户: [发送包含文字的图片]
系统: 已接收到图片（共1张），是否继续发送图片还是根据图片提问？
用户: 帮我读出图片中的文字
系统: 图片中的文字内容是：...
```

## 技术架构

### 核心组件

1. **ImageSessionService** (`app/services/image_session_service.py`)
   - 管理用户的图片上传会话
   - 处理图片下载和存储
   - 提供会话状态查询和清理功能

2. **WeChatService** (`app/services/wechat_service.py`)
   - 接收和解析微信图片消息
   - 协调图片下载和AI处理流程
   - 发送回复消息给用户

3. **LLMService** (`app/services/llm_service.py`)
   - 新增 `chat_with_images()` 方法
   - 将图片和文本一起发送给 Gemini API
   - 处理AI响应并返回结果

### 数据流程

```
微信服务器 → routes.py → WeChatService
                              ↓
                    [图片消息类型判断]
                              ↓
                    ImageSessionService
                    [下载并存储图片]
                              ↓
                    [用户发送文本提问]
                              ↓
                        LLMService
                    [调用Gemini API]
                              ↓
                    [返回AI分析结果]
                              ↓
                    [清空图片会话]
```

## 配置要求

### 1. 模型配置
图片理解功能需要使用 Gemini 模型，在 `config.py` 中确保：

```python
CURRENT_LLM = 'geminiofficial-flash'  # 或 'geminiofficial-pro'
```

### 2. 上传目录
图片默认保存在 `uploads/` 目录，系统会自动创建该目录。

### 3. 依赖库
确保已安装 `google-genai` SDK：

```bash
pip install google-genai
```

## API 参数说明

### Gemini 图片理解 API

根据官方文档，Gemini 支持以下图片处理方式：

1. **内嵌图片数据**（当前实现）
   - 适合小文件（总请求 < 20MB）
   - 直接读取本地文件并转换为字节

2. **File API**（可选升级）
   - 适合大文件或重复使用同一图片
   - 需要先上传文件获取引用

### Token 计算

- 小图片（≤384px）：258 tokens
- 大图片：按图块计算，每个 768x768 图块 258 tokens

## 限制和注意事项

### 1. 图片数量限制
- Gemini 支持每个请求最多 3,600 个图片文件
- 建议单次会话不超过 10 张图片

### 2. 图片大小限制
- 微信临时素材有效期：3天
- 建议图片大小 < 10MB

### 3. 会话超时
- 图片会话超时时间：10分钟
- 超时后会话自动清空

### 4. 模型支持
- 仅 Gemini 模型支持图片理解
- DeepSeek 等其他模型暂不支持

## 故障排查

### 问题1：图片下载失败
**原因**：AccessToken 过期或 MediaId 无效
**解决**：检查微信配置，确保 AppID 和 AppSecret 正确

### 问题2：AI 无法理解图片
**原因**：未使用 Gemini 模型
**解决**：在 config.py 中设置 `CURRENT_LLM = 'geminiofficial-flash'`

### 问题3：图片会话丢失
**原因**：会话超时（10分钟）
**解决**：提醒用户在接收图片后尽快提问

## 扩展建议

### 1. 对象检测
可使用 Gemini 2.5 的对象检测功能，识别图片中的物体并获取边界框：

```python
prompt = "Detect all objects in the image. Return bounding boxes."
```

### 2. 图片分割
Gemini 2.5 支持更精确的图像分割，可识别物体轮廓：

```python
prompt = "Segment the main objects in this image."
```

### 3. OCR 增强
针对文字识别场景，可添加专门的提示词：

```python
prompt = "Extract all text from this image, preserving the layout."
```

## 更新日志

### v1.0.0 (2025-10-20)
- ✅ 实现图片接收和下载功能
- ✅ 实现图片会话管理
- ✅ 集成 Gemini 图片理解 API
- ✅ 支持多图片处理
- ✅ 自动会话清理机制

## 开发者信息

- **开发时间**：2025年10月20日
- **使用技术**：Python Flask, Google Gemini API, WechatPy
- **测试状态**：✅ 通过基础功能测试

---

**提示**：如需了解更多 Gemini 图片处理能力，请参考 [Google Gemini 官方文档](https://ai.google.dev/gemini-api/docs/vision)

