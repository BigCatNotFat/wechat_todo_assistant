# 图片处理功能 - 快速启动指南

## 🚀 立即开始使用

### 第1步：确认配置

打开 `config.py`，确认已使用支持图片的模型：

```python
# 当前使用的模型 (修改这里来切换模型)
CURRENT_LLM = 'geminiofficial-flash'  # ✅ 支持图片
# CURRENT_LLM = 'deepseek'  # ❌ 不支持图片
```

### 第2步：启动服务器

```bash
python run.py
```

看到以下输出说明图片功能已启用：

```
图片会话服务已启动 - 上传目录: .../uploads, 会话超时: 10分钟
✅ 使用 Google Genai SDK - 主模型: gemini-2.5-flash
```

### 第3步：微信测试

1. 打开微信，找到你的服务号
2. 发送一张图片
3. 应该收到回复：**"已接收到图片（共1张），是否继续发送图片还是根据图片提问？"**
4. 发送文本提问，例如："这是什么？"
5. 等待AI分析并返回结果

## 📱 测试场景示例

### 场景1：识别物品
```
步骤：
1. 拍摄一个物品的照片并发送
2. 收到确认："已接收到图片（共1张）..."
3. 发送："这是什么？"
4. 查看AI的识别结果
```

### 场景2：读取文字（OCR）
```
步骤：
1. 拍摄包含文字的图片（如书籍、海报、标志等）
2. 收到确认："已接收到图片（共1张）..."
3. 发送："读出图片中的文字"
4. 查看提取的文字内容
```

### 场景3：对比两张图
```
步骤：
1. 发送第一张图片
2. 收到确认："已接收到图片（共1张）..."
3. 发送第二张图片
4. 收到确认："已接收到图片（共2张）..."
5. 发送："这两张图有什么区别？"
6. 查看对比分析结果
```

### 场景4：图片说明
```
步骤：
1. 发送一张风景照或其他图片
2. 收到确认："已接收到图片（共1张）..."
3. 发送："详细描述这张图片"
4. 查看AI生成的图片说明
```

## 🔍 功能验证清单

运行测试脚本验证功能：

```bash
python test_image_feature.py
```

期望输出：

```
✅ 图片会话服务测试通过！
✅ 当前模型支持图片理解: gemini-2.5-flash
✅ 所有测试完成！
```

## 📊 检查上传的图片

图片会保存在 `uploads/` 目录：

```bash
# Windows
dir uploads

# Linux/Mac
ls -la uploads/
```

文件命名格式：`用户OpenID_时间戳.扩展名`

示例：`oXXXXXXXXXXXX_20251020_143052_123456.jpg`

## ⚙️ 常见问题

### Q1: 收不到图片确认消息？
**检查项**:
- [ ] 服务器是否正常运行？
- [ ] 微信服务器配置是否正确？
- [ ] 查看日志，是否有 "收到用户 XXX 的图片消息" 的输出？

**解决方法**:
```bash
# 查看实时日志
tail -f logs/app.log  # Linux/Mac
```

### Q2: AI回复"不支持图片处理功能"？
**原因**: 当前使用的模型不支持图片

**解决方法**:
1. 打开 `config.py`
2. 修改 `CURRENT_LLM = 'geminiofficial-flash'`
3. 重启服务器

### Q3: 图片下载失败？
**检查项**:
- [ ] AccessToken是否有效？查看日志中的AccessToken获取状态
- [ ] 网络是否畅通？测试能否访问微信API
- [ ] MediaId是否正确？

**调试方法**:
查看日志中的详细错误信息：
```
❌ 下载图片失败，HTTP状态码: XXX
响应内容: ...
```

### Q4: 会话丢失，AI不识别之前发的图？
**原因**: 会话超时（10分钟）或已经处理过一次

**说明**:
- 每次发送文本提问后，图片会话会自动清空
- 10分钟内未发送消息，会话自动过期
- 这是正常行为，确保不同对话间互不干扰

### Q5: 图片理解速度慢？
**说明**:
- 单张图片：通常5-10秒
- 多张图片：10-20秒
- 这是正常的AI处理时间

**优化建议**:
- 发送较小的图片（压缩后）
- 一次不要发送太多图片（建议≤5张）

## 📝 使用技巧

### 技巧1：提问越具体，回答越准确
❌ 不好的提问："说说这个"
✅ 好的提问："详细描述图片中的物品材质、颜色和用途"

### 技巧2：利用多图对比功能
发送多张图片后，可以问：
- "这些图片有什么共同点？"
- "按照时间顺序排列这些图片"
- "找出这些图片中的异常项"

### 技巧3：结合上下文提问
虽然图片会话是独立的，但AI仍然记得之前的文本对话。

示例：
```
用户: 我想装修厨房
AI: 好的，我可以帮你...
用户: [发送厨房设计图]
用户: 这个设计怎么样？
AI: 结合您想装修厨房的需求，这个设计...
```

### 技巧4：OCR后处理
```
用户: [发送文档图片]
用户: 读出文字并整理成列表
AI: [提取并整理文字]
```

## 🛡️ 安全和隐私

### 图片存储
- 图片保存在本地 `uploads/` 目录
- 建议定期清理旧图片
- 生产环境建议设置文件自动清理策略

### 数据传输
- 图片会发送到Google Gemini API进行分析
- 遵循Google的隐私政策
- 不要发送敏感或机密图片

### 清理脚本示例

创建 `cleanup_old_images.py`：

```python
import os
import time
from datetime import datetime, timedelta

UPLOAD_DIR = 'uploads'
DAYS_TO_KEEP = 7  # 保留7天内的图片

def cleanup_old_images():
    """删除7天前的图片"""
    cutoff_time = time.time() - (DAYS_TO_KEEP * 86400)
    count = 0
    
    for filename in os.listdir(UPLOAD_DIR):
        filepath = os.path.join(UPLOAD_DIR, filename)
        if os.path.isfile(filepath):
            if os.path.getmtime(filepath) < cutoff_time:
                os.remove(filepath)
                count += 1
                print(f"删除: {filename}")
    
    print(f"清理完成，删除了 {count} 个旧图片")

if __name__ == '__main__':
    cleanup_old_images()
```

定期运行：
```bash
# 手动运行
python cleanup_old_images.py

# 或添加到系统定时任务（crontab）
# 每天凌晨3点清理
0 3 * * * cd /path/to/project && python cleanup_old_images.py
```

## 📈 监控和统计

### 查看统计信息

可以在代码中调用：

```python
from app import create_app

app = create_app()
with app.app_context():
    stats = app.image_session_service.get_stats()
    print(stats)
```

输出示例：
```python
{
    'total_sessions': 5,        # 当前活跃会话数
    'total_images': 12,         # 总图片数
    'avg_images_per_session': 2.4,  # 平均每会话图片数
    'session_timeout_minutes': 10   # 会话超时时间
}
```

## 🎯 下一步

### 探索更多功能
- 发送多张图片试试对比功能
- 测试OCR文字识别能力
- 尝试让AI分析复杂场景

### 功能扩展
- 查看 `图片处理功能说明.md` 了解更多技术细节
- 阅读 Google Gemini 官方文档探索高级功能
- 考虑集成对象检测、图像分割等高级特性

### 生产部署
- 配置Nginx反向代理
- 设置定时清理任务
- 添加图片大小限制
- 监控API调用量和成本

## 💡 反馈和支持

如有问题或建议：
1. 查看 `图片处理功能说明.md` 中的详细文档
2. 查看 `图片功能实现总结.md` 了解技术细节
3. 提交Issue报告问题

---

**祝使用愉快！🎉**

