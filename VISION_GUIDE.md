# Gemini 图片理解功能指南

## 功能概述

本应用已集成 Gemini 的图片理解（Vision）功能，可以让 AI 助手理解和分析用户发送的图片。

## 功能特点

- ✅ **图片识别** - 识别图片中的物体、场景、文字
- ✅ **智能分析** - 结合图片和文字问题进行回答
- ✅ **历史保存** - 图片保存在对话历史中，可持续使用
- ✅ **多轮对话** - 发送图片后可以多次提问
- ✅ **自动判断** - AI 自动决定是否需要使用历史图片

## 配置说明

### 1. 模型配置

在 `config.py` 中，`geminiofficial` 配置已启用图片支持：

```python
'geminiofficial': {
    'api_key': 'YOUR_API_KEY',
    'api_base': 'https://generativelanguage.googleapis.com/v1beta/openai/',
    'model': 'gemini-2.5-pro',
    'temperature': 0.7,
    'max_tokens': 10000,
    'use_google_search': True,   # Google搜索
    'use_genai_sdk': True,        # Google Genai SDK
    'support_vision': True         # ✅ 图片理解
}
```

### 2. 启用图片功能

```python
# config.py
CURRENT_LLM = 'geminiofficial'  # 必须使用此配置
```

⚠️ **注意**：只有 `geminiofficial` 支持图片理解功能。

## 使用方式

### 基础用法

1. **发送图片**
   - 用户在微信中发送图片
   - 助手回复："✅ 收到图片！我已经保存了这张图片，请继续发送您的问题..."

2. **提问**
   - 用户发送文字问题
   - AI 会自动结合图片内容来回答

### 使用场景

#### 1. 图片识别
```
用户: [发送一张食物图片]
助手: ✅ 收到图片！请继续发送您的问题...

用户: 这是什么食物？
助手: 这是一份意大利面配番茄酱...
```

#### 2. 文字识别（OCR）
```
用户: [发送一张包含文字的图片]
助手: ✅ 收到图片！

用户: 帮我识别图片中的文字
助手: 图片中的文字内容是：...
```

#### 3. 物体检测
```
用户: [发送一张室内图片]
助手: ✅ 收到图片！

用户: 这张图片里有什么？
助手: 图片中包含：一张桌子、两把椅子、一盏台灯...
```

#### 4. 图片问答
```
用户: [发送一张产品图片]
助手: ✅ 收到图片！

用户: 这个产品大概多少钱？
助手: 根据图片中的产品特征，这款产品的价格大约在...
```

#### 5. 多轮对话
```
用户: [发送图片]
助手: ✅ 收到图片！

用户: 分析一下这张图片
助手: [详细分析...]

用户: 图片中的颜色是什么？
助手: 图片主要颜色是蓝色和白色...

用户: 还有其他特点吗？
助手: 还有以下特点：[继续分析同一张图片]
```

## 技术原理

### 1. 图片处理流程

```
用户发送图片
    ↓
微信服务器接收
    ↓
下载图片（使用 Media API）
    ↓
保存到对话历史（bytes + mime_type）
    ↓
回复确认消息
    ↓
用户发送文字问题
    ↓
从历史中提取图片
    ↓
发送给 Gemini API（图片+文字）
    ↓
返回分析结果
```

### 2. 对话历史结构

```python
{
    "role": "user",
    "content": "[图片]",
    "image_data": {
        "bytes": b"...",           # 图片字节数据
        "mime_type": "image/jpeg"  # 图片类型
    },
    "timestamp": datetime(...)
}
```

### 3. 图片保存策略

- ✅ 保存在内存中（不占用磁盘空间）
- ✅ 跟随对话历史管理
- ✅ 最多保留 10 轮对话（包括图片）
- ✅ 24 小时后自动清理

### 4. 支持的图片格式

- ✅ JPEG (.jpg, .jpeg)
- ✅ PNG (.png)
- ✅ GIF (.gif)
- ✅ WebP (.webp)

### 5. 图片大小限制

- 微信限制：单张图片最大 10MB
- API 限制：请求总大小（包括图片）< 20MB
- 建议：单张图片 < 5MB 以获得最佳性能

## 控制台输出

当处理图片时，控制台会显示：

```
收到用户 user_123 的图片消息
成功下载图片，大小: 245678 字节
✅ 已保存图片到对话历史，类型: image/jpeg，大小: 245678 字节

调用 Gemini API，模型: gemini-2.5-pro，Google Search: True，Vision: True
🖼️ 检测到对话历史中包含 True 张图片，将发送给模型
第1轮调用 - 输入token: 350, 输出token: 120
==================================================
本次对话Token统计:
  总输入token: 350
  总输出token: 120
  总计token: 470
==================================================
```

## 最佳实践

### ✅ 推荐做法

1. **清晰的图片**
   - 光线充足
   - 对焦清晰
   - 主体明确

2. **具体的问题**
   - "这是什么品牌的手机？" ✅
   - "分析一下" ❌（太笼统）

3. **一次一张图**
   - 先发一张图片
   - 再提多个问题

4. **及时提问**
   - 发送图片后立即提问
   - 避免中间插入其他话题

### ❌ 避免的做法

1. **不清晰的图片**
   - 模糊不清
   - 光线不足
   - 角度不佳

2. **敏感内容**
   - 个人隐私信息
   - 身份证、银行卡等

3. **过大的文件**
   - 超过 5MB 的图片
   - 可能导致上传失败

## 常见问题

### Q1: 为什么我发送图片后AI没有理解？

**A:** 请检查：
1. 是否使用 `geminiofficial` 配置
2. 是否在发送图片后提出了问题
3. 图片是否下载成功（查看控制台日志）

### Q2: AI 说不支持图片怎么办？

**A:** 在 `config.py` 中设置：
```python
CURRENT_LLM = 'geminiofficial'
```
然后重启服务。

### Q3: 可以同时发送多张图片吗？

**A:** 目前一次只能发送一张图片，但可以：
1. 发送第一张图片
2. 提问并得到回答
3. 发送第二张图片
4. 继续提问

### Q4: 图片会保存多久？

**A:** 图片保存在对话历史中：
- 最多保留 10 轮对话
- 或 24 小时内有效
- 以先到者为准

### Q5: 如何清除历史图片？

**A:** 使用系统命令：
```
#清空历史
```
会清除所有对话历史，包括图片。

### Q6: 图片功能会增加很多成本吗？

**A:** 是的，图片会增加 token 消耗：
- 普通文字：约 100-500 tokens
- 包含图片：约 500-2000 tokens
- 建议根据需要使用

## 与其他功能的配合

### 图片 + Google Search

```
用户: [发送一张建筑图片]
助手: ✅ 收到图片！

用户: 这是什么建筑？它的历史是什么？
助手: [自动搜索] 这是埃菲尔铁塔，建于1889年...
```

AI 会：
1. 识别图片中的建筑
2. 使用 Google 搜索查询相关历史
3. 综合图片和搜索结果回答

### 图片 + 待办管理

⚠️ **注意**：图片功能和 Function Calling（待办管理）目前不能同时使用。

**建议方案**：
- 需要图片识别 → 使用 `geminiofficial`
- 需要待办管理 → 切换到 `deepseek` 或 `geminihiapi`

## 模型对比

| 功能 | geminiofficial | deepseek | geminihiapi |
|------|----------------|----------|-------------|
| 图片理解 | ✅ | ❌ | ❌ |
| Google Search | ✅ | ❌ | ❌ |
| Function Calling | ❌ | ✅ | ✅ |
| 待办管理 | ❌ | ✅ | ✅ |
| 成本 | 中 | 低 | 低 |

## 使用提示

### 💡 提示 1：准确描述需求

**不好的提问**：
- "看看这个"
- "分析"

**好的提问**：
- "这张图片里的植物是什么品种？"
- "帮我识别这张收据上的金额"

### 💡 提示 2：利用对话历史

发送图片后，可以连续提多个问题，AI 会记住图片内容：

```
用户: [图片]
助手: ✅ 收到图片！

用户: 这是什么？
助手: 这是一只金毛犬...

用户: 它大概几岁？
助手: 从图片来看，这只狗大约2-3岁...

用户: 它健康吗？
助手: 从外观看，它的毛发有光泽...
```

### 💡 提示 3：组合使用功能

```
用户: [发送菜单图片]
助手: ✅ 收到图片！

用户: 这道菜的热量大概多少？营养价值如何？
助手: [分析图片 + 搜索营养信息] 这道菜的热量约为...
```

## 故障排除

### 问题：图片上传失败

**解决方案**：
1. 检查网络连接
2. 压缩图片大小
3. 更换图片格式

### 问题：AI 识别不准确

**解决方案**：
1. 重新拍摄更清晰的图片
2. 提供更具体的问题
3. 补充文字说明

### 问题：Token 消耗过快

**解决方案**：
1. 压缩图片质量
2. 只在必要时使用图片功能
3. 清除不需要的历史图片

## 示例代码

### 测试图片功能

```python
# 暂时不支持直接API调用测试
# 请通过微信客户端测试
```

### 通过微信测试

1. 关注你的微信公众号
2. 发送一张图片
3. 等待确认消息
4. 发送问题
5. 查看AI的回答

## 更新日志

- **2024-10-17**: 初始版本，集成 Gemini 图片理解功能

## 相关文档

- [Google Search 指南](GOOGLE_SEARCH_GUIDE.md)
- [项目使用文档](USAGE.md)
- [Gemini Vision API 文档](https://ai.google.dev/gemini-api/docs/vision)

---

**提示**：图片功能最适合用于识别、分析和理解视觉内容，请根据实际需求选择合适的模型。

