# ç³»ç»Ÿå‘½ä»¤ä½¿ç”¨æŒ‡å—

## ğŸ“– æ¦‚è¿°

ç³»ç»Ÿå‘½ä»¤åŠŸèƒ½å…è®¸ç”¨æˆ·é€šè¿‡å‘é€ç‰¹å®šçš„å…³é”®è¯æ¥æ‰§è¡Œç³»ç»Ÿçº§æ“ä½œï¼Œè¿™äº›å‘½ä»¤ä¸ä¼šç»è¿‡å¤§æ¨¡å‹å¤„ç†ï¼Œè€Œæ˜¯ç›´æ¥ç”± `CommandService` å¤„ç†ï¼Œå“åº”é€Ÿåº¦æ›´å¿«ä¸”æ›´å¯é ã€‚

## ğŸ¯ æ¶æ„è¯´æ˜

### å¤„ç†æµç¨‹

```
å¾®ä¿¡æ¶ˆæ¯ â†’ routes.py (è§£å¯†)
          â†“
    wechat_service.handle_message()
          â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ æ˜¯ç³»ç»Ÿå‘½ä»¤å—ï¼Ÿ   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â†“ YES              â†“ NO
   command_service     â†’   llm_service
   (ç«‹å³è¿”å›ç»“æœ)         (AIå¤„ç†)
```

### ä»£ç ä½ç½®

- **å‘½ä»¤æœåŠ¡**: `app/services/command_service.py`
- **æœåŠ¡æ³¨å†Œ**: `app/__init__.py`
- **æ¶ˆæ¯è·¯ç”±**: `app/wechat/routes.py`
- **æ¶ˆæ¯å¤„ç†**: `app/services/wechat_service.py`

## ğŸ“‹ å½“å‰æ”¯æŒçš„å‘½ä»¤

| å‘½ä»¤ | åˆ«å | åŠŸèƒ½ | ç¤ºä¾‹ |
|------|------|------|------|
| `clear` | - | æ¸…ç©ºå¯¹è¯å†å² | å‘é€ "clear" |
| `help` | `å¸®åŠ©` | æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯ | å‘é€ "help" æˆ– "å¸®åŠ©" |
| `stats` | `ç»Ÿè®¡` | æŸ¥çœ‹ç»Ÿè®¡æ•°æ® | å‘é€ "stats" æˆ– "ç»Ÿè®¡" |
| `reset` | `é‡ç½®` | é‡ç½®æ‰€æœ‰æ•°æ®ï¼ˆæ…ç”¨ï¼‰ | å‘é€ "reset" æˆ– "é‡ç½®" |

## ğŸ› ï¸ å¦‚ä½•æ·»åŠ æ–°å‘½ä»¤

### æ–¹æ³•1: ç®€å•å‘½ä»¤ï¼ˆæ¨èï¼‰

åœ¨ `app/services/command_service.py` ä¸­æ·»åŠ ï¼š

```python
def __init__(self, conversation_service, todo_service):
    # ... ç°æœ‰ä»£ç  ...
    
    self.commands = {
        # ... ç°æœ‰å‘½ä»¤ ...
        'version': self._show_version,  # æ·»åŠ æ–°å‘½ä»¤
        'ç‰ˆæœ¬': self._show_version,     # ä¸­æ–‡åˆ«å
    }

def _show_version(self, user_id):
    """æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯"""
    return """ğŸ“¦ åœ¨åŠå°åŠ©æ‰‹ v1.0.0
    
åŠŸèƒ½ç‰¹æ€§ï¼š
â€¢ æ™ºèƒ½å¾…åŠç®¡ç†
â€¢ å¯¹è¯ä¸Šä¸‹æ–‡è®°å¿†
â€¢ æ¯æ—¥ä»»åŠ¡è§„åˆ’

æ›´æ–°æ—¶é—´: 2024-10-17"""
```

### æ–¹æ³•2: éœ€è¦å‚æ•°çš„å‘½ä»¤

```python
def __init__(self, conversation_service, todo_service):
    # ç‰¹æ®Šå¤„ç†ï¼šå¸¦å‚æ•°çš„å‘½ä»¤éœ€è¦å•ç‹¬æ£€æµ‹
    pass

def is_system_command(self, message):
    """åˆ¤æ–­æ˜¯å¦æ˜¯ç³»ç»Ÿå‘½ä»¤"""
    msg = message.strip().lower()
    
    # ç²¾ç¡®åŒ¹é…çš„å‘½ä»¤
    if msg in self.commands:
        return True
    
    # å¸¦å‚æ•°çš„å‘½ä»¤ï¼ˆä¾‹å¦‚: delete 1ï¼‰
    if msg.startswith('delete '):
        return True
    
    return False

def execute_command(self, message, user_id):
    """æ‰§è¡Œç³»ç»Ÿå‘½ä»¤"""
    msg = message.strip().lower()
    
    # å¤„ç†å¸¦å‚æ•°çš„å‘½ä»¤
    if msg.startswith('delete '):
        todo_id = msg.split(' ')[1]
        return self._delete_todo(user_id, todo_id)
    
    # å¤„ç†æ™®é€šå‘½ä»¤
    if msg in self.commands:
        return self.commands[msg](user_id)
    
    return None

def _delete_todo(self, user_id, todo_id):
    """åˆ é™¤å¾…åŠ"""
    try:
        success = self.todo_service.delete_todo(int(todo_id), user_id)
        if success:
            return f"âœ… å·²åˆ é™¤å¾…åŠäº‹é¡¹ #{todo_id}"
        else:
            return f"âŒ å¾…åŠäº‹é¡¹ #{todo_id} ä¸å­˜åœ¨"
    except ValueError:
        return "âŒ å¾…åŠIDå¿…é¡»æ˜¯æ•°å­—"
```

## ğŸ“ å‘½ä»¤è®¾è®¡æœ€ä½³å®è·µ

### 1. å‘½ä»¤å‘½åè§„èŒƒ

- âœ… ä½¿ç”¨ç®€çŸ­ã€æ˜“è®°çš„è‹±æ–‡å•è¯
- âœ… æä¾›ä¸­æ–‡åˆ«åä»¥æå‡ç”¨æˆ·ä½“éªŒ
- âœ… å‘½ä»¤åä¸åŒºåˆ†å¤§å°å†™
- âœ… è‡ªåŠ¨å»é™¤å‰åç©ºæ ¼

```python
# å¥½çš„ä¾‹å­
'clear'  â†’ æ¸…ç©º
'help'   â†’ å¸®åŠ©
'stats'  â†’ ç»Ÿè®¡

# ä¸å¥½çš„ä¾‹å­
'clearconversationhistory'  # å¤ªé•¿
'clr'                       # ä¸ç›´è§‚
```

### 2. è¿”å›æ¶ˆæ¯æ ¼å¼

ä½¿ç”¨è¡¨æƒ…ç¬¦å·å’Œæ ¼å¼åŒ–æ–‡æœ¬æå‡å¯è¯»æ€§ï¼š

```python
def _example_command(self, user_id):
    return """âœ… æ“ä½œæˆåŠŸ

ğŸ“Š ç»Ÿè®¡æ•°æ®ï¼š
â€¢ é¡¹ç›®1: 10
â€¢ é¡¹ç›®2: 20

ğŸ’¡ æç¤ºï¼šå¯ä»¥ä½¿ç”¨ help æŸ¥çœ‹æ›´å¤šå‘½ä»¤"""
```

### 3. é”™è¯¯å¤„ç†

æ‰€æœ‰å‘½ä»¤å¤„ç†å‡½æ•°éƒ½åº”åŒ…å«å¼‚å¸¸å¤„ç†ï¼š

```python
def _risky_command(self, user_id):
    """å¯èƒ½å‡ºé”™çš„å‘½ä»¤"""
    try:
        # æ‰§è¡Œå¯èƒ½å‡ºé”™çš„æ“ä½œ
        result = self.do_something(user_id)
        return f"âœ… æ“ä½œæˆåŠŸ: {result}"
    except ValueError as e:
        return f"âŒ å‚æ•°é”™è¯¯: {str(e)}"
    except Exception as e:
        print(f"å‘½ä»¤æ‰§è¡Œå¼‚å¸¸: {e}")
        import traceback
        traceback.print_exc()
        return "âŒ æ“ä½œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•"
```

## ğŸ§ª æµ‹è¯•å‘½ä»¤

### è¿è¡Œæµ‹è¯•è„šæœ¬

```bash
python test_command.py
```

### æ‰‹åŠ¨æµ‹è¯•

1. å¯åŠ¨åº”ç”¨ï¼š`python run.py`
2. åœ¨å¾®ä¿¡ä¸­å‘é€å‘½ä»¤å…³é”®è¯
3. æŸ¥çœ‹æ§åˆ¶å°è¾“å‡ºå’Œå¾®ä¿¡å›å¤

### æµ‹è¯•æ¸…å•

- [ ] å‘½ä»¤èƒ½æ­£ç¡®è¯†åˆ«ï¼ˆåŒ…æ‹¬å¤§å°å†™ã€ç©ºæ ¼ï¼‰
- [ ] ä¸­æ–‡åˆ«åèƒ½æ­£å¸¸å·¥ä½œ
- [ ] è¿”å›æ¶ˆæ¯æ ¼å¼æ­£ç¡®ã€æ¸…æ™°
- [ ] é”™è¯¯æƒ…å†µæœ‰å‹å¥½çš„æç¤º
- [ ] ä¸å½±å“æ­£å¸¸çš„AIå¯¹è¯åŠŸèƒ½

## ğŸ” è°ƒè¯•æŠ€å·§

### æŸ¥çœ‹å‘½ä»¤æ˜¯å¦è¢«è¯†åˆ«

åœ¨ `app/services/wechat_service.py` çš„ `handle_message()` ä¸­æœ‰æ—¥å¿—ï¼š

```python
if command_service and command_service.is_system_command(user_message):
    print(f"æ£€æµ‹åˆ°ç³»ç»Ÿå‘½ä»¤: {user_message}")  # è¿™é‡Œä¼šæ‰“å°
    return command_service.execute_command(user_message, user_id)
```

### æŸ¥çœ‹æ‰€æœ‰æ³¨å†Œçš„å‘½ä»¤

```python
# åœ¨ä»£ç ä¸­
all_commands = app.command_service.get_all_commands()
print(f"æ”¯æŒçš„å‘½ä»¤: {all_commands}")
```

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. å‘½ä»¤ä¼˜å…ˆçº§

ç³»ç»Ÿå‘½ä»¤çš„ä¼˜å…ˆçº§**é«˜äº** AI å¯¹è¯å¤„ç†ï¼Œè¿™æ„å‘³ç€ï¼š

- âœ… ç”¨æˆ·å‘é€ "help" ä¼šè§¦å‘ç³»ç»Ÿå¸®åŠ©ï¼Œè€Œä¸æ˜¯ AI å›ç­”
- âš ï¸ é¿å…ä½¿ç”¨å¸¸è§è¯ä½œä¸ºå‘½ä»¤ï¼ˆå¦‚ "ä½ å¥½"ã€"è°¢è°¢"ï¼‰
- âš ï¸ å‘½ä»¤å…³é”®è¯åº”è¯¥è¶³å¤Ÿç‰¹æ®Šï¼Œä¸æ˜“è¯¯è§¦å‘

### 2. å¯¹è¯å†å²

- ç³»ç»Ÿå‘½ä»¤**ä¸ä¼š**è¢«è®°å½•åˆ°å¯¹è¯å†å²ä¸­
- ç³»ç»Ÿå‘½ä»¤çš„å›å¤**ä¹Ÿä¸ä¼š**è¢«è®°å½•åˆ°å¯¹è¯å†å²
- è¿™æ ·å¯ä»¥ä¿æŒå¯¹è¯ä¸Šä¸‹æ–‡çš„çº¯å‡€

### 3. æ€§èƒ½è€ƒè™‘

- ç³»ç»Ÿå‘½ä»¤ç›´æ¥è¿”å›ï¼Œä¸è°ƒç”¨ LLMï¼Œé€Ÿåº¦æ›´å¿«
- é€‚åˆé¢‘ç¹ä½¿ç”¨çš„åŠŸèƒ½ï¼ˆå¦‚æŸ¥çœ‹ç»Ÿè®¡ã€æ¸…ç©ºå†å²ï¼‰
- ä¸é€‚åˆéœ€è¦è‡ªç„¶è¯­è¨€ç†è§£çš„åŠŸèƒ½

## ğŸ“š æ‰©å±•ç¤ºä¾‹

### ç¤ºä¾‹1: å¯¼å‡ºå¾…åŠäº‹é¡¹

```python
def _export_todos(self, user_id):
    """å¯¼å‡ºå¾…åŠäº‹é¡¹ä¸ºæ–‡æœ¬æ ¼å¼"""
    todos = self.todo_service.get_user_todos(user_id)
    
    if not todos:
        return "ğŸ“­ æš‚æ— å¾…åŠäº‹é¡¹"
    
    result = ["ğŸ“‹ æˆ‘çš„å¾…åŠäº‹é¡¹\n"]
    
    for i, todo in enumerate(todos, 1):
        status = "âœ…" if todo.status == 'completed' else "â³"
        result.append(f"{i}. {status} {todo.content}")
        if todo.due_date:
            result.append(f"   â° {todo.due_date.strftime('%Y-%m-%d')}")
    
    return "\n".join(result)
```

### ç¤ºä¾‹2: å¿«æ·å›å¤

```python
def _quick_reply(self, user_id):
    """å¸¸ç”¨å¿«æ·å›å¤"""
    return """âš¡ å¿«æ·æ“ä½œï¼š
    
å›å¤æ•°å­—é€‰æ‹©ï¼š
1ï¸âƒ£ æŸ¥çœ‹ä»Šæ—¥å¾…åŠ
2ï¸âƒ£ æŸ¥çœ‹æœ¬å‘¨å¾…åŠ
3ï¸âƒ£ æ·»åŠ æ–°å¾…åŠ
4ï¸âƒ£ è¿”å›ä¸»èœå•

è¯·ç›´æ¥å›å¤æ•°å­—..."""
```

## ğŸ“ æ€»ç»“

ç³»ç»Ÿå‘½ä»¤åŠŸèƒ½æä¾›äº†ä¸€ç§å¿«é€Ÿã€å¯é çš„æ–¹å¼æ¥å¤„ç†ç‰¹å®šæ“ä½œï¼Œé€‚åˆï¼š

- âœ… ç³»ç»Ÿç®¡ç†ç±»æ“ä½œï¼ˆæ¸…ç©ºã€é‡ç½®ï¼‰
- âœ… æŸ¥è¯¢ç»Ÿè®¡ä¿¡æ¯
- âœ… æ˜¾ç¤ºå¸®åŠ©æ–‡æ¡£
- âœ… å¿«æ·åŠŸèƒ½å…¥å£

ä¸é€‚åˆï¼š

- âŒ éœ€è¦è‡ªç„¶è¯­è¨€ç†è§£çš„ä»»åŠ¡
- âŒ å¤æ‚çš„ä¸šåŠ¡é€»è¾‘
- âŒ éœ€è¦ä¸Šä¸‹æ–‡ç†è§£çš„å¯¹è¯

åˆç†ä½¿ç”¨ç³»ç»Ÿå‘½ä»¤å¯ä»¥æå‡ç”¨æˆ·ä½“éªŒï¼Œè®©å¸¸ç”¨æ“ä½œæ›´å¿«æ·ï¼

