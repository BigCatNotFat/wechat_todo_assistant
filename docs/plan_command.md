# Plan 命令使用说明

## 功能概述

`plan` 命令是一个智能任务规划系统命令，能够自动获取今天和明天的所有待办任务，并由 AI 助手根据任务的轻重缓急、耗时情况和重要性生成科学合理的执行规划。

## 使用方法

用户只需发送以下任一命令即可触发任务规划功能：

- `plan` - 英文命令
- `规划` - 中文命令

## 功能特点

### 1. 全面的任务信息收集

系统会自动收集以下信息：

**今天的任务：**
- 所有未完成且创建于今天的任务
- 所有截止日期在今天的任务

**明天的任务：**
- 所有截止日期在明天的未完成任务

**任务详细信息包括：**
- 任务内容
- 任务备注
- 截止时间（含剩余时间或超时提示）
- 创建时间

### 2. 智能分析维度

AI 助手会从以下六个维度进行分析：

1. **紧急程度分析**
   - 识别即将到期或已超时的任务
   - 标注需要优先处理的紧急任务

2. **任务难度评估**
   - 根据任务描述和备注评估复杂度
   - 预估每个任务可能需要的时间

3. **执行顺序建议**
   - 按照"重要且紧急 > 重要不紧急 > 紧急不重要 > 不重要不紧急"原则排序
   - 考虑任务之间的依赖关系和逻辑顺序
   - 合理安排高效率时段处理难度大的任务

4. **时间分配建议**
   - 为每个任务建议具体的执行时间段
   - 预留缓冲时间应对突发情况
   - 注意劳逸结合，避免疲劳作战

5. **风险提示**
   - 指出可能无法按时完成的任务
   - 对超时任务给出应对建议

6. **执行建议**
   - 提供具体可行的执行策略
   - 给出提高效率的小技巧

### 3. 友好的输出格式

- 使用清晰的结构和分段
- 用 emoji 增加可读性（如⚡紧急、⭐重要、⏰时间等）
- 避免 Markdown 格式，使用纯文本（适合微信）
- 使用数字编号、换行分段组织内容
- 语气专业友好，给予用户鼓励和信心

## 使用场景

### 场景 1：早晨规划当日任务

```
用户: plan
系统: [sys] 📋 任务规划建议

【今天的待办】(共3个)
• 任务：完成项目报告
  备注：需要包含数据分析部分
  截止时间：2025-10-23 18:00 (剩余 8 小时)
  创建时间：2025-10-23 09:00

• 任务：团队会议
  截止时间：2025-10-23 14:00 (剩余 4 小时)
  创建时间：2025-10-22 16:00

• 任务：回复客户邮件
  备注：关于合同细节的问题
  创建时间：2025-10-23 09:30

【明天的待办】(共1个)
• 任务：准备演讲PPT
  备注：下周一要用
  截止时间：2025-10-24 17:00 (剩余 1 天)
  创建时间：2025-10-22 14:00

AI 生成的规划建议...
```

### 场景 2：没有待办任务

```
用户: 规划
系统: [sys] 📝 您暂时没有今天和明天的待办任务，先休息一下吧！
```

## 技术实现

### 架构设计

```
用户输入 "plan"
    ↓
command_service.py (系统命令服务)
    ↓
调用 _generate_plan(user_id)
    ↓
├── todo_service.get_today_todos(user_id)      # 获取今天的任务
├── todo_service.get_tomorrow_todos(user_id)   # 获取明天的任务
├── 格式化任务详细信息
├── prompt_manager.get_prompt('task_planning_prompt')  # 获取提示词
└── llm_service 生成规划建议
    ↓
返回规划结果给用户
```

### 关键文件

1. **app/services/command_service.py**
   - 新增 `_generate_plan()` 方法
   - 在命令字典中注册 `plan` 和 `规划` 命令

2. **app/services/todo_service.py**
   - 新增 `get_tomorrow_todos()` 方法

3. **prompts/prompts.yml**
   - 新增 `task_planning_prompt` 提示词模板

## 注意事项

1. **明天任务的判定**：只包含截止日期明确设置在明天的任务
2. **今天任务的判定**：包含创建于今天或截止日期在今天的所有未完成任务
3. **时间计算**：自动计算任务的剩余时间或超时时长
4. **权限控制**：只能查看和规划当前用户自己的任务

## 扩展建议

未来可以考虑的扩展功能：

1. 支持指定日期范围的规划（如本周、下周）
2. 添加任务标签和分类，支持按类别规划
3. 支持定时自动推送每日规划
4. 根据用户的历史完成情况优化时间预估
5. 支持任务优先级字段，提高规划精准度

## 相关命令

- `help` / `帮助` - 查看所有系统命令
- `stats` / `统计` - 查看任务统计信息
- `models` - 查看可用的 AI 模型

