# 记账功能说明

## 功能概述

在办小助手现已新增完整的记账功能，用户可以通过自然语言与AI对话来记录收支、查询余额、统计汇总等。

## 核心功能

### 1. 支出记录 (record_expense)
- **功能**：记录一笔支出
- **触发语句示例**：
  - "今天花了50块钱买菜"
  - "午饭花了30元"
  - "买了一件衣服200块"
  - "支出100元，打车费"
- **参数**：
  - `amount`: 支出金额（正数）
  - `notes`: 支出说明（可选）

### 2. 收入记录 (record_income)
- **功能**：记录一笔收入
- **触发语句示例**：
  - "今天收入500元"
  - "工资到账5000"
  - "兼职赚了200块"
  - "收到转账1000元"
- **参数**：
  - `amount`: 收入金额（正数）
  - `notes`: 收入说明（可选）

### 3. 资金矫正 (adjust_balance)
- **功能**：矫正账户余额，用于修正记账错误
- **触发语句示例**：
  - "矫正余额+500"
  - "修正账目-200"
- **参数**：
  - `amount`: 矫正金额（正数或负数）
  - `notes`: 矫正原因说明（可选）

### 4. 余额查询 (get_balance)
- **功能**：查询当前账户余额
- **触发语句示例**：
  - "查询余额"
  - "还剩多少钱"
  - "我的账户余额"
- **返回**：当前账户总余额

### 5. 记账记录查询 (get_transactions)
- **功能**：查询历史记账记录
- **触发语句示例**：
  - "查看最近的消费记录"
  - "显示最近7天的支出"
  - "看看我的收入记录"
- **参数**：
  - `transaction_type`: 记录类型（expense/income/adjustment/all）
  - `days`: 查询最近N天的记录
  - `limit`: 返回记录数量限制（默认10条）

### 6. 收支汇总 (get_financial_summary)
- **功能**：统计指定时间段的收支情况
- **触发语句示例**：
  - "本月花了多少钱"
  - "最近30天的收支情况"
  - "统计一下最近的财务状况"
- **参数**：
  - `days`: 统计最近N天（默认30天）
- **返回信息**：
  - 总收入
  - 总支出
  - 净收益
  - 矫正金额
  - 记录条数
  - 当前总余额

## 数据库设计

### Transaction 表结构
```python
class Transaction(db.Model):
    id              # 主键
    user_id         # 用户ID（外键）
    amount          # 金额（正数=收入，负数=支出）
    type            # 类型：expense/income/adjustment
    notes           # 备注说明
    created_at      # 记录时间
    updated_at      # 更新时间
```

## 技术架构

### 1. 数据模型层
- **文件**：`app/models/transaction.py`
- **功能**：定义 Transaction 数据模型

### 2. 服务层
- **文件**：`app/services/transaction_service.py`
- **功能**：提供记账业务逻辑，包括：
  - `create_expense()`: 创建支出记录
  - `create_income()`: 创建收入记录
  - `adjust_balance()`: 资金矫正
  - `get_balance()`: 获取余额
  - `get_user_transactions()`: 查询记录
  - `get_period_summary()`: 收支汇总
  - `delete_transaction()`: 删除记录

### 3. 工具层
- **文件**：`app/utils/llm_tools.py`
- **功能**：
  - 在 `TOOLS_SCHEMA` 中定义了6个记账相关的函数 Schema
  - 在 `LLMTools` 类中实现了对应的方法

### 4. LLM服务层
- **文件**：`app/services/llm_service.py`
- **更新**：
  - 接收 `transaction_service` 参数
  - 创建 `LLMTools` 时传入 `transaction_service`
  - 添加记账工具的中文显示名称映射

### 5. 应用工厂
- **文件**：`app/__init__.py`
- **更新**：
  - 初始化 `TransactionService`
  - 将 `transaction_service` 传递给 `LLMService`

### 6. 提示词配置
- **文件**：`prompts/prompts.yml`
- **更新**：
  - 系统提示词中添加记账功能说明
  - 更新工具使用规则，详细说明记账工具的触发场景

### 7. 数据关联
- **文件**：`app/models/user.py`
- **更新**：在 User 模型中添加与 Transaction 的一对多关系

## 使用示例

### 示例1：记录支出
```
用户：今天花了50块钱买菜
AI：✅ 已记录支出：50元
备注：买菜
当前余额：950元

[已调用记录支出]
```

### 示例2：记录收入
```
用户：工资到账5000
AI：💰 已记录收入：5000元
备注：工资
当前余额：5950元

[已调用记录收入]
```

### 示例3：查询余额
```
用户：查询余额
AI：📊 您的当前余额：5950元

[已调用查询余额]
```

### 示例4：收支汇总
```
用户：本月花了多少钱
AI：📈 最近30天收支汇总：

总收入：5000元
总支出：50元
净收益：4950元
当前余额：5950元
记录条数：2条

[已调用收支汇总]
```

## 注意事项

1. **金额处理**：
   - 支出金额在数据库中以负数存储
   - 收入金额以正数存储
   - 矫正金额可正可负

2. **余额计算**：
   - 余额 = 所有交易记录的金额总和
   - 支持负余额（透支状态）

3. **时间记录**：
   - 每条记录自动记录创建时间 (`created_at`)
   - 支持按时间范围查询和统计

4. **用户隔离**：
   - 所有记录通过 `user_id` 进行用户隔离
   - 用户只能查看和操作自己的记录

## 扩展建议

未来可以考虑添加：
1. **分类标签**：为收支添加分类（如餐饮、交通、娱乐等）
2. **预算管理**：设置月度预算，超支提醒
3. **图表统计**：生成收支趋势图表
4. **导出功能**：导出Excel账单
5. **定期记账**：支持设置定期收支（如每月房租）
6. **多账户**：支持多个账户管理（如现金、银行卡、信用卡）

## 测试建议

启动应用后，可以通过以下方式测试记账功能：

1. **基础测试**：
   - "花了100块买书" → 测试支出记录
   - "收入2000元" → 测试收入记录
   - "查询余额" → 测试余额查询

2. **查询测试**：
   - "查看最近的消费记录" → 测试记录查询
   - "本月花了多少钱" → 测试收支汇总

3. **矫正测试**：
   - "矫正余额+500元，补充初始金额" → 测试资金矫正

---

**开发完成时间**：2025-10-19
**版本**：v1.0

